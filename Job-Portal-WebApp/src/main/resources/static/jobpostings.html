<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Manage Job Postings</title>
    <link rel="stylesheet" href="css/jobposting.css" />
  </head>
  <body>
    <header class="main-header">
      <h1>Manage Job Postings</h1>
    </header>

    <main class="main-content">
      <!-- CREATE JOB POSTING FORM -->
      <section class="create-job">
        <h2>Create New Job Posting</h2>
        <form id="createJobForm">
          <input type="text" id="title" placeholder="Job Title" required />
          <textarea
            id="description"
            placeholder="Job Description"
            required
          ></textarea>
          <input type="text" id="location" placeholder="Location" required />
          <input
            type="number"
            id="companyId"
            placeholder="Company ID"
            required
          />
          <button type="submit">Create Job</button>
        </form>
      </section>

      <!-- JOB POSTINGS LIST -->
      <section class="job-list-section">
        <h2>All Job Postings</h2>
        <div id="jobPostingsList">Loading jobs...</div>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const jobListEl = document.getElementById("jobPostingsList");
        const createForm = document.getElementById("createJobForm");

        // Load all jobs
        async function loadJobs() {
          jobListEl.innerHTML = "Loading jobs...";
          try {
            const response = await fetch("/api/jobpostings");
            if (!response.ok) throw new Error("Failed to load jobs");
            const jobs = await response.json();

            if (jobs.length === 0) {
              jobListEl.innerHTML = "<p>No job postings found.</p>";
              return;
            }

            jobListEl.innerHTML = jobs
              .map(
                (job) => `
                    <div class="job-item">
                        <h3>${job.title}</h3>
                        <p>${job.description}</p>
                        <p><strong>Location:</strong> ${job.location}</p>
                        <p><strong>Company ID:</strong> ${job.companyId}</p>
                        <button onclick="viewJob(${job.id})">View</button>
                        <button onclick="deleteJob(${job.id})">Delete</button>
                    </div>
                `
              )
              .join("");
          } catch (err) {
            jobListEl.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
          }
        }

        loadJobs(); // initial load

        // Submit new job posting
        createForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          const data = {
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            location: document.getElementById("location").value,
            companyId: Number(document.getElementById("companyId").value),
          };

          try {
            const response = await fetch("/api/jobpostings", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              alert("Job created successfully!");
              createForm.reset();
              loadJobs();
            } else {
              throw new Error("Failed to create job");
            }
          } catch (err) {
            alert("Error: " + err.message);
          }
        });

        // View job posting
        window.viewJob = async function (id) {
          try {
            const response = await fetch(`/api/jobpostings/${id}`);
            if (!response.ok) throw new Error("Job not found");
            const job = await response.json();
            alert(
              `Job Details:\nTitle: ${job.title}\nDescription: ${job.description}\nLocation: ${job.location}\nCompanyId: ${job.companyId}`
            );
          } catch (err) {
            alert("Error: " + err.message);
          }
        };

        // Delete job posting
        window.deleteJob = async function (id) {
          if (!confirm("Are you sure you want to delete this job posting?"))
            return;

          try {
            const response = await fetch(`/api/jobpostings/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("Job deleted successfully!");
              loadJobs();
            } else {
              throw new Error("Failed to delete job");
            }
          } catch (err) {
            alert("Error: " + err.message);
          }
        };
      });
    </script>
  </body>
</html>
